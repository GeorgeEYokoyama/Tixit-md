<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./node_modules/simplemde/dist/simplemde.min.css">
</head>
<body></body>
<script src="../node_modules/proto/dist/proto.umd.js"></script>
<script src="../node_modules/gem/dist/Gem.umd.js"></script>
<script src="../ExtensionTester.umd.js"></script>

<script src="./node_modules/simplemde/dist/simplemde.min.js" charset="utf-8"></script>
<script>

/***** Plugin *****/

// A plugin class
var mdEditor = proto(Gem, function (superclass) {
    // Plugin Name - required
    this.name = "mdEditor";

    // Plugin Constructor - required
    this.build = function (ticket, options, api) {
        if (options === undefined) options = {};
        this.label = options.label;

        this.mdContainer = Gem.TextArea("mdContainer");
        this.add(this.mdContainer);

        var mdeConfig = {
            element: this.mdContainer.domNode,
            placeholder: "description",
            status: false,
            spellChecker: false,
            toolbar: ["bold", "italic", "code", "|", "unordered-list", "ordered-list", "table", "|", "link", "image", "|", "preview", "guide"]
        };

        // Instantiate Markdown Editor
        var simplemde = new SimpleMDE(mdeConfig);

        // Save and Load
        var ignoreObject = {};
        var fieldObservee = ticket.get(options.field);
        // Initialize Markdown Editor
        simplemde.value(fieldObservee.subject);
        // Save
        simplemde.codemirror.on("change", function () {
            ticket.data({ignore: ignoreObject}).set(options.field, simplemde.value());
        });

        // Load
        fieldObservee.on("change", function (change) {
            if (!(change.data && ignoreObject === change.data.ignore)) {
                simplemde.value(fieldObservee.subject);
            }
        });

    };


    // Plugin Styling - optional
    this.style =  Gem.Style({

    });

});

/***** Virtual Ticket *****/

// Create an instance of the plugin
ExtensionTester.Api.Ticket.create().then(function(newOne) {
    newOne.subject.content = 'Stored data'

    ExtensionTester(mdEditor, { label: "mdEditor", field: "content" }, { ticketId: newOne.subject._id, showEditor: true });

}).done()

</script>
